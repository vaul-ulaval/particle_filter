particle_filter:
  ros__parameters:
    # topic names
    scan_topic: "/autodrive/roboracer_1/lidar"
    odometry_topic: "/odom" # raw wheel odom - EKF will smooth PF output

    # range data downsampling
    angle_step: 20
    max_particles: 2000
    squash_factor: 0.5 # LOWER = more LiDAR correction (was 2.2, too high!)

    # Module D: corridor-based squash adjustment
    enable_corridor_squash: false
    squash_factor_corridor: 1.5 # in corridors, trust odom more (lower = more odom trust)
    corridor_alpha: 0.3 # filter smoothing (0-1)
    corridor_wall_threshold: 6.0 # max range to consider as wall (meters)
    # visualization
    viz: 1
    max_viz_particles: 100
    # ray marching method
    range_method: "glt" # rmgpu if cuda available
    theta_discretization: 112.0
    # range data filtering
    max_range: 11.0
    publish_odom: 1
    # sensor model constants
    z_short: 0.01 # Weight for shorter than expected range r < d
    z_max: 0.07 # Weight for maximum range r = d
    z_rand: 0.12 # back to normal
    z_hit: 0.80 # trust LiDAR more now that odom is correct

    sigma_hit: 8.0 # back to normal

    # motion model dispersion constants (baseline Gaussian std-dev in meters/rad)
    # INCREASED to allow particles to explore when odom drifts
    motion_dispersion_x: 0.05
    motion_dispersion_y: 0.05
    motion_dispersion_theta: 0.1
    # slip adaptive noise parameters (modulate motion noise + odom attenuation)
    # Uses IMU acceleration integration to detect wheel slip independently
    # Core slip filter
    slip_alpha: 0.3 # slip filter smoothing
    slip_reference_floor: 0.5
    slip_wheel_timeout: 0.3

    # Module A: slip -> motion noise scaling
    enable_slip_motion: false
    slip_scale_x: 0.4 # add motion noise when slipping
    slip_scale_y: 0.2
    slip_scale_theta: 0.2
    slip_max_x: 1.0
    slip_max_y: 1.0
    slip_max_theta: 1.0

    # Module B: slip -> odom attenuation
    enable_slip_odom: false
    slip_odom_gain: 2.0 # attenuate odometry displacement when slipping
    slip_odom_min_factor: 0.3 # minimum factor for odometry displacement

    # Module C: IMU-based slip reference
    enable_imu_slip: true
    wheel_speed_topic: "/wheel_odom"
    # IMU-based slip detection (independent velocity reference)
    imu_topic: "/autodrive/roboracer_1/imu_unbiased"
    imu_speed_alpha: 0.1 # integration decay factor (high = forget faster)
    # sensor model variant, variant 2 good for rmgpu, 3 doesn't work for rmgpu
    rangelib_variant: 2

    # initial posez
    set_initial_pose: true
    init_pose_x: 0.750
    init_pose_y: 7.658
    init_pose_z: 0.059
    init_orientation_x: 0.011
    init_orientation_y: 0.011
    init_orientation_z: -0.707
    init_orientation_w: 0.707
